### **项目名称：恋心物语 (Native WeChat Mini Program)**

**项目唯一标识**: `lianxin-wuyu-miniprogram`

---

### **第一部分：总指令与核心要求**

**你的任务是**: 作为一名资深的微信小程序前端开发者，严格、完整、精确地执行以下所有规范和要求，开发「恋心物语」微信小程序的全部前端代码。

**核心要求**:
1.  **技术栈**: 必须使用 **原生微信小程序框架** (`WXML`, `WXSS`, `TypeScript`)、状态管理库 **mobx-miniprogram**、以及 **SCSS** 作为样式预处理器。
2.  **UI框架**: **[最重要]** 整个项目 **必须** 使用 **iView Weapp** UI 组件库进行开发。禁止手写功能重复的自定义组件。
3.  **代码目录**: 所有前端代码必须创建在根目录下的 `/miniapp/` 文件夹内。
4.  **数据契约**: **【最重要】** 本文档第五部分提供了由后端定义的、包含所有场景的 **完整模拟数据 (Mock Data)**。你的所有开发都必须 **严格以此数据为唯一真实来源** 进行，确保前端组件的字段、数据结构与此完全匹配。在后端接口未完成时，你可以直接使用这些数据作为本地假数据进行开发。
5.  **代码风格**: 遵循 `ESLint` 和 `Prettier` 的规范，确保代码整洁、可读性强。
6.  **注释**: 对所有非直观的业务逻辑、算法、状态管理副作用（effects）等，添加清晰的中文注释。

---

### **第二部分：UI/UX 设计系统规范 (基于 iView Weapp)**

你必须严格按照以下视觉规范，通过配置 iView Weapp 组件的属性和自定义样式来实现所有页面。

**2.1 iView Weapp 安装与配置**

*   **前置知识**: 开始前，你应已熟悉[微信小程序自定义组件](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/)的官方文档。
*   **组件获取**: 本项目的前端UI组件库 `iView Weapp` 已通过 `git clone` 下载，并将其 `dist` 目录复制到了 `/miniapp/` 目录下，重命名为 `iview`。你的所有组件引用路径都基于此结构。
*   **组件使用方式**:
    1.  **全局引入**: 为方便起见，常用的基础组件已在 `/miniapp/app.json` 中全局引入，你可以在所有页面中直接使用它们，无需在页面`.json`中重复声明。
        ```json
        // app.json
        "usingComponents": {
          "i-button": "/iview/button/index",
          "i-card": "/iview/card/index",
          "i-tag": "/iview/tag/index",
          "i-progress": "/iview/progress/index",
          "i-panel": "/iview/panel/index",
          "i-avatar": "/iview/avatar/index",
          "i-icon": "/iview/icon/index"
        }
        ```
    2.  **页面级引入**: 如果某个组件仅在特定页面使用，可以在该页面的 `.json` 配置文件中，添加 `usingComponents` 字段。路径必须从项目根目录开始。例如，在 `pages/somepage/index.json` 中引入一个开关组件：
        ```json
        "usingComponents": {
          "i-switch": "/miniapp/iview/switch/index" 
        }
        ```
    3.  **WXML中使用**: 在 `wxml` 文件中，像使用普通标签一样使用 iView 组件。
        ```xml
        <i-button type="primary" bind:click="handleClick">这是一个按钮</i-button>
        ```

**2.2 视觉基调与全局样式覆盖**
*   **主题**: 「⼿绘日系软萌」— 低饱和度粉蓝对比 + 奶油底色。
*   **色系 (在 `app.wxss` 或全局 `_variables.scss` 中定义)**:
    *   `$color-primary: #FADADD;` (这将作为 iView 的主色)
    *   `$color-info: #B2D9EA;` (这将作为 iView 的 info 色)
    *   `$color-accent: #FFF3B0;`
    *   `$color-background: #FFF9F5;`
    *   `$color-text: #333333;`
*   **全局样式**: 在 `app.wxss` 中设置全局背景色:
    ```css
    page {
      background-color: #FFF9F5;
      color: #333333;
    }
    ```
*   **iView 颜色覆盖**: 在 `app.wxss` 中，通过设置 CSS 变量来覆盖 iView Weapp 的默认主题色，以匹配我们的设计。
    ```css
    page {
        --primary-color: #FADADD;
        --info-color: #B2D9EA;
        /* 根据需要覆盖其他颜色变量 */
    }
    ```

**2.3 iView Weapp 组件使用规范**
你需要在开发中，使用以下 iView 组件来构成页面元素：

| 项目需求         | iView 组件 (`<i-xxx>`) | 关键属性/实现细节                                                                                               |
| :--------------- | :--------------------- | :-------------------------------------------------------------------------------------------------------------- |
| **主操作按钮**   | `i-button`             | `type="primary"` (颜色已被覆盖为粉色), `shape="circle"`, `size="large"`, `long="true"` (如果需要通栏按钮)           |
| **卡片容器**     | `i-card`               | `full="true"`，通过 `i-card` 的 `name` slot 放置标题。内容通过默认 slot 插入。                                  |
| **状态标签**     | `i-tag`                | 根据事件类型，使用`color`属性。例如 `color="primary"` (粉色系) 或 `color="info"` (蓝色系)                          |
| **进度条**       | `i-progress`           | `stroke-color` 设置为我们的主色 `#FADADD`，`percent` 动态绑定。                                      |
| **头像**         | `i-avatar`             | `src`绑定用户头像URL，`shape="circle"`                                                                          |
| **图标**         | `i-icon`               | `type` 属性使用 iView 内置的图标名。                                                                            |
| **面板/分组**    | `i-panel`              | `title` 属性设置分组标题。                                                                                      |
| **心情选择器**   | 自定义组件             | 此组件仍需自定义，但可以**内部使用** `i-grid` 和 `i-grid-item` 布局，每个 item 中放置一个 `i-icon` 或 `image`。 |

---

### **第三部分：技术架构与文件结构**

**3.1 最终文件结构**

你必须严格按照以下目录结构创建和组织所有代码文件。这是项目的骨架，任何文件都不能放错位置。

```
/miniapp/
|-- components/             # 全局自定义组件 (例如 MoodPicker)
|-- iview/                  # 【已存在】iView Weapp 组件库，请勿修改
|-- pages/                  # 所有页面
|   |-- index/              # 首页
|   |-- profile/            # 个人中心
|   |-- auth/               # 授权登录页
|   |-- couple/             # 情侣绑定页
|   |-- event-detail/       # 事件详情页
|   |-- event-add/          # 新增事件页
|   |-- ...                 # 其他业务页面
|-- services/               # API 服务, 业务逻辑封装
|   |-- api.js              # 封装 wx.request, 统一处理请求
|   |-- auth.js             # 登录、认证相关逻辑
|-- store/                  # 全局状态管理 (MobX)
|   |-- user.js             # 用户及情侣信息
|   |-- event.js            # 事件(帖子)列表
|   |-- index.js            # 组合并导出所有 store
|-- styles/                 # 全局样式
|   |-- _variables.scss     # SCSS 变量 (颜色, 尺寸等)
|   |-- app.scss            # 全局 SCSS 入口文件
|-- types/                  # TypeScript 类型定义
|   |-- index.ts            # 全局类型
|   |-- api.ts              # API 响应数据类型
|-- utils/                  # 工具函数 (例如日期格式化)
|-- app.js                  # 小程序入口
|-- app.json                # 全局配置 (路由, 窗口表现)
|-- app.wxss                # 全局样式表 (由 app.scss 编译生成)
|-- project.config.json     # 项目配置文件
```

**3.2 核心服务实现**
*   **API客户端 (`/miniapp/services/api.js`)**: 严格按照`前端开发文档.md`中的示例，封装`wx.request`，实现请求拦截、Token自动注入、`401`统一处理和业务错误`wx.showToast`提示。
*   **状态管理 (`/miniapp/store/`)**:
    *   在 `store/` 目录下为不同业务模块（如 `user`, `event`）创建独立的`store`文件。
    *   使用`mobx-miniprogram`的`observable`创建状态，`action`创建方法。
    *   在`app.js`的`onLaunch`中，将所有`store`实例挂载到`getApp().store`上，并实现路由守卫逻辑。

**3.3 TypeScript类型**
在 `/miniapp/types/` 目录下，根据第五部分的模拟数据和API接口，创建完整的`api.ts`类型定义文件，并在`index.ts`中进行组合导出。

---

### **第四部分：分步开发路线图**

请按照以下顺序和要求开发各个页面：

**Phase 1: 核心认证流程**
1.  **`pages/auth/index` (登录页)**:
    *   **UI**: 页面中央放置一个 `<i-button type="primary" shape="circle" size="large">微信授权登录</i-button>`。
    *   **逻辑**: 点击按钮后，调用`wx.login()`获取`code`，然后调用`POST /auth/login`接口。成功后，将返回的`access_token`存入`wx.storage`，并调用`userStore.fetchUserSession()`，最后根据`userStore.isCoupleBound`的值，使用`wx.reLaunch`跳转到首页或绑定页。

2.  **`pages/couple/index` (情侣绑定页)**:
    *   **UI**: 使用 `<i-panel>` 和 `<i-input>`、`<i-button>` 构建界面。
    *   **逻辑**:
        *   进入页面时，若自己未绑定，则调用 `POST /couples/invitations` 获取自己的邀请码并显示。
        *   点击"确认绑定"后，调用`POST /couples/accept-invitation`。成功后，同样调用`userStore.fetchUserSession()`并跳转到首页。

**Phase 2: 核心内容模块**
1.  **`pages/index/index` (首页)**:
    *   **UI**:
        *   顶部使用 `<i-avatar>` 显示情侣头像。
        *   中间使用 `<i-progress>` 组件，`percent` 绑定 `userStore.coupleInfo.connection_score`。
        *   下方使用 `<i-card>` 循环渲染 `eventStore.unresolvedEvents`。
        *   右下角悬浮按钮使用 `<i-icon type="add" size="28" color="#ffffff">` 并自定义一个圆形背景。
    *   **逻辑**: 使用`mobx-miniprogram-bindings`将`userStore`和`eventStore`绑定到页面。在`onShow`生命周期中调用`eventStore.fetchUnresolvedEvents()`刷新列表。点击"+"按钮跳转到新增事件页。

2.  **后续页面 (事件新增/详情、个人中心等)**:
    *   根据`功能描述文档 — 「恋心物语」.md`中的描述，继续开发其余页面。
    *   所有数据请求和状态变更，都必须通过对应的`store`中的`action`来完成。

---

### **第五部分：【唯一真实来源】后端API接口与模拟数据契约**

**所有前端的页面渲染、组件开发、数据绑定、逻辑判断，都必须严格、完全地基于以下模拟数据结构。这是保证前后端顺利对接的基石。**

#### **1. `GET /api/me` - 获取当前会话信息**

**场景 1.1：管理员用户**
```json
{
  "code": 200,
  "message": "Session info for an admin retrieved successfully.",
  "data": {
    "access_status": "ADMIN",
    "currentUser": {
      "id": "a1b2c3d4-0001-4001-8001-0123456789ab",
      "openid": "openid-for-admin-user-01",
      "nickname": "阿涛 (管理员)",
      "avatar_url": "https://randomuser.me/api/portraits/men/32.jpg",
      "display_gender": "male",
      "bio": "系统的守护者，偶尔也记录生活。",
      "status": "active",
      "is_admin": true,
      "preferences": {
        "notifications": {
          "new_event_push": true,
          "event_resolved_push": true,
          "new_message_push": false
        },
        "theme": "dark"
      },
      "last_login_at": "2023-10-27T10:00:00Z",
      "created_at": "2023-01-15T12:00:00Z"
    },
    "partner": {
      "id": "a1b2c3d4-0002-4002-8002-fedcba987654",
      "nickname": "小月",
      "avatar_url": "https://randomuser.me/api/portraits/women/44.jpg",
      "display_gender": "female",
      "bio": "爱画画，爱旅行，也爱身边的管理员先生。"
    },
    "coupleInfo": {
      "id": "c1p2l3e4-0001-4001-8001-abcdef123456",
      "anniversary_date": "2020-01-01",
      "trial_ends_at": null,
      "subscription_expires_at": null
    }
  }
}
```

**场景 1.2：付费订阅生效中的用户**
```json
{
  "code": 200,
  "message": "Session info for a subscribed user retrieved successfully.",
  "data": {
    "access_status": "FULL_ACCESS",
    "currentUser": {
      "id": "b2c3d4e5-0003-4003-8003-112233445566",
      "openid": "openid-for-paid-user-03",
      "nickname": "付费用户A",
      "avatar_url": "https://randomuser.me/api/portraits/women/68.jpg",
      "display_gender": "female",
      "bio": "享受每一刻的甜蜜记录。",
      "status": "active",
      "is_admin": false,
      "preferences": {
        "notifications": {
          "new_event_push": true,
          "event_resolved_push": true,
          "new_message_push": true
        },
        "theme": "light"
      },
      "last_login_at": "2023-10-26T18:30:00Z",
      "created_at": "2022-08-01T11:00:00Z"
    },
    "partner": {
      "id": "b2c3d4e5-0004-4004-8004-aabbccddeeff",
      "nickname": "付费用户B",
      "avatar_url": "https://randomuser.me/api/portraits/men/68.jpg",
      "display_gender": "male",
      "bio": "为我们的爱投资，值得。"
    },
    "coupleInfo": {
      "id": "c1p2l3e4-0002-4002-8002-654321fedcba",
      "anniversary_date": "2022-08-08",
      "trial_ends_at": "2022-09-08T12:00:00Z",
      "subscription_expires_at": "2024-09-08T12:00:00Z"
    }
  }
}
```

**场景 1.3：免费试用期内的用户**
```json
{
  "code": 200,
  "message": "Session info for a user in trial period retrieved successfully.",
  "data": {
    "access_status": "TRIAL",
    "currentUser": {
      "id": "c3d4e5f6-0005-4005-8005-abcdefabcdef",
      "openid": "openid-for-trial-user-05",
      "nickname": "试用用户A",
      "avatar_url": "https://randomuser.me/api/portraits/men/50.jpg",
      "display_gender": "male",
      "bio": "正在体验这个神奇的小程序！",
      "status": "active",
      "is_admin": false,
      "preferences": {
        "notifications": {
          "new_event_push": true,
          "event_resolved_push": false,
          "new_message_push": true
        },
        "theme": "system"
      },
      "last_login_at": "2023-10-27T14:00:00Z",
      "created_at": "2023-10-15T18:30:00Z"
    },
    "partner": {
      "id": "c3d4e5f6-0006-4006-8006-fedcbafedcba",
      "nickname": "试用用户B",
      "avatar_url": "https://randomuser.me/api/portraits/women/50.jpg",
      "display_gender": "female",
      "bio": "试用期感觉不错哦。"
    },
    "coupleInfo": {
      "id": "c1p2l3e4-0003-4003-8003-789789789789",
      "anniversary_date": "2023-10-15",
      "trial_ends_at": "2023-11-15T18:30:00Z",
      "subscription_expires_at": null
    }
  }
}
```

**场景 1.4：订阅/试用已到期的用户**
```json
{
  "code": 200,
  "message": "Access expired. Subscription required.",
  "data": {
    "access_status": "EXPIRED",
    "currentUser": {
      "id": "d4e5f6g7-0007-4007-8007-778899aabbcc",
      "openid": "openid-for-expired-user-07",
      "nickname": "过期用户A",
      "avatar_url": "https://randomuser.me/api/portraits/women/25.jpg",
      "display_gender": "female",
      "bio": "我们的甜蜜时光需要续费啦...",
      "status": "active",
      "is_admin": false,
      "preferences": {
        "notifications": {
          "new_event_push": true,
          "event_resolved_push": true,
          "new_message_push": true
        },
        "theme": "light"
      },
      "last_login_at": "2023-10-27T14:10:00Z",
      "created_at": "2021-03-14T10:00:00Z"
    },
    "partner": {
      "id": "d4e5f6g7-0008-4008-8008-ccddeeff0011",
      "nickname": "过期用户B",
      "avatar_url": "https://randomuser.me/api/portraits/men/25.jpg",
      "display_gender": "male",
      "bio": "是时候充值信仰了。"
    },
    "coupleInfo": {
      "id": "c1p2l3e4-0004-4004-8004-101101101101",
      "anniversary_date": "2021-03-14",
      "trial_ends_at": "2021-04-14T10:00:00Z",
      "subscription_expires_at": "2022-04-14T10:00:00Z"
    }
  }
}
```

**场景 1.5：未绑定情侣的用户**
```json
{
  "code": 200,
  "message": "User is not bound to a couple.",
  "data": {
    "access_status": "UNBOUND",
    "currentUser": {
      "id": "e5f6g7h8-0009-4009-8009-1a2b3c4d5e6f",
      "openid": "openid-for-single-user-09",
      "nickname": "单身贵族C",
      "avatar_url": "https://randomuser.me/api/portraits/lego/1.jpg",
      "display_gender": "male",
      "bio": "寻找我的另一半。",
      "status": "active",
      "is_admin": false,
      "preferences": {
        "notifications": {
          "new_event_push": true,
          "event_resolved_push": true,
          "new_message_push": true
        },
        "theme": "system"
      },
      "last_login_at": "2023-10-27T14:20:00Z",
      "created_at": "2023-09-01T20:00:00Z"
    },
    "partner": null,
    "coupleInfo": null
  }
}
```

#### **2. `GET /api/events?status=unresolved` - 获取首页帖子列表 (未解决)**
```json
{
  "code": 200,
  "message": "Unresolved events retrieved successfully.",
  "data": [
    {
      "id": "evt-uuid-001",
      "couple_id": "c1p2l3e4-0002-4002-8002-654321fedcba",
      "type": "brainstorming",
      "description": "说好的一起看电影，结果开场十分钟就睡着了，呼噜打得比电影声还响！",
      "status": "unresolved",
      "solution": null,
      "event_date": "2023-10-26",
      "images": [],
      "location_text": "家里的沙发上",
      "author": {
        "id": "b2c3d4e5-0003-4003-8003-112233445566",
        "nickname": "付费用户A",
        "display_gender": "female"
      },
      "mood_tag": {
        "id": 1,
        "name": "生气",
        "emoji_icon": "😠"
      },
      "reactions": [],
      "resolved_at": null,
      "created_at": "2023-10-26T22:30:00Z",
      "updated_at": "2023-10-26T22:30:00Z"
    },
    {
      "id": "evt-uuid-002",
      "couple_id": "c1p2l3e4-0002-4002-8002-654321fedcba",
      "type": "sweet_moment",
      "description": "今天加班到很晚，回家发现他给我炖了汤，还准备了小惊喜，太感动了。",
      "status": "unresolved",
      "solution": null,
      "event_date": "2023-10-25",
      "images": [
        "https://images.pexels.com/photos/262959/pexels-photo-262959.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
      ],
      "location_text": null,
      "author": {
        "id": "b2c3d4e5-0003-4003-8003-112233445566",
        "nickname": "付费用户A",
        "display_gender": "female"
      },
      "mood_tag": {
        "id": 5,
        "name": "感动",
        "emoji_icon": "🥰"
      },
      "reactions": [
        { "author_id": "b2c3d4e5-0004-4004-8004-aabbccddeeff", "emoji": "❤️" }
      ],
      "resolved_at": null,
      "created_at": "2023-10-25T23:00:00Z",
      "updated_at": "2023-10-25T23:00:00Z"
    }
  ]
}
```

#### **3. `GET /api/mood-tags` - 获取所有可用的情绪标签**
```json
{
  "code": 200,
  "message": "Mood tags retrieved successfully.",
  "data": [
    { "id": 1, "name": "生气", "emoji_icon": "😠", "category": "negative", "impact_on_connection_score": -5, "score": 2 },
    { "id": 2, "name": "委屈", "emoji_icon": "🥺", "category": "negative", "impact_on_connection_score": -3, "score": 3 },
    { "id": 3, "name": "无语", "emoji_icon": "😑", "category": "negative", "impact_on_connection_score": -2, "score": 4 },
    { "id": 4, "name": "平常", "emoji_icon": "😐", "category": "neutral", "impact_on_connection_score": 0, "score": 6 },
    { "id": 5, "name": "感动", "emoji_icon": "🥰", "category": "positive", "impact_on_connection_score": 5, "score": 9 },
    { "id": 6, "name": "开心", "emoji_icon": "😄", "category": "positive", "impact_on_connection_score": 3, "score": 8 },
    { "id": 7, "name": "惊喜", "emoji_icon": "😮", "category": "positive", "impact_on_connection_score": 4, "score": 9 }
  ]
}
```

**(篇幅限制，此处省略`模拟后端返回数据.md`中的其他API模拟数据，但实际生成时应包含所有内容)**

---
**执行指令**: 现在，请根据以上所有规范和数据，开始实现`miniapp`的开发工作。确保所有UI都通过`iView Weapp`组件库实现。从Phase 1开始，创建文件并编写代码。
