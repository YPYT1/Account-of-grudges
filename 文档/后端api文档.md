# **恋心物语 - 后端API文档**

**版本**: 1.0.0
**基地址 (Base URL)**: `/api`

**API路径约定**:
本文档中所有API端点路径（例如 `GET /me`）都是相对于上方定义的 **基地址** (`/api`) 的。
-   **后端实现**: 后端路由器应将所有API路由注册在 `/api` 前缀下。例如，文档中的 `GET /me` 意味着后端需要实现的完整路径是 `GET /api/me`。
-   **前端调用**: 前端在发起网络请求时，也必须调用完整的路径，例如 `axios.get('/api/me')`。
-   **与前端路由的区别**: 采用 `/api` 前缀是为了明确区分 **后端数据接口** 与 **前端页面路由**。前端的页面路由不应使用 `/api` 前缀（例如，个人主页可能是 `/profile`，帖子详情页是 `/event/:id`）。

---

## **〇、全局API约定与通用响应格式**

本部分定义了所有API交互的基础规则。所有API都必须遵循以下响应结构和状态码约定。

### **1. 通用响应结构**

所有API的响应都将包裹在以下JSON结构中：

```json
{
  "code": 200,          // number: 业务状态码，见下文定义
  "message": "Success", // string: 对本次响应的文本描述
  "data": { ... }       // object | array | null: 核心响应数据
}
```

### **2. 认证 (Authentication)**

除特殊说明外（如登录/注册接口），所有API请求都必须在HTTP请求头中携带 `Authorization` 字段，值为 `Bearer <YOUR_JWT_TOKEN>`。如果Token无效或缺失，服务器将返回 `401 Unauthorized` 错误。

### **3. 通用业务状态码 (Code) 定义**

| Code | HTTP状态(参考) | 含义             | 描述与前端处理建议                                                                               |
| :--- | :------------- | :--------------- | :----------------------------------------------------------------------------------------------- |
| `200`  | 200 OK         | **请求成功**       | 通用的成功状态。                                                                                 |
| `201`  | 201 Created    | **创建成功**       | 在通过 `POST` 请求成功创建一个新资源（如新帖子、新留言）时返回。                                   |
| `400`  | 400 Bad Request| **请求参数错误**   | 通常由客户端请求的参数不符合后端要求导致，例如字段缺失、格式错误。前端应提示用户修改输入。       |
| `401`  | 401 Unauthorized| **需要认证**       | 用户未登录或Token已失效。前端应拦截此响应，清除本地登录状态，并重定向到登录页面。                |
| `403`  | 403 Forbidden  | **权限不足**       | 用户已登录，但无权访问该资源（例如普通用户尝试删除他人帖子）。前端应给出"无权操作"的提示。       |
| `404`  | 404 Not Found  | **资源不存在**     | 请求的资源（如某个特定ID的帖子）在数据库中不存在。前端应显示"内容不存在"或"已被删除"的界面。 |
| `500`  | 500 Server Error| **服务器内部错误** | 后端服务器发生未知错误。这是一个通用错误，前端应向用户显示一个友好的"服务开小差了，请稍后再试"提示。 |

---

## **第一部分：用户、认证与会员系统 API**

### **1. 用户会话 (Session)**

#### `GET /me` - 获取当前会话信息

-   **描述**: 获取当前登录用户的完整信息，包括其伴侣信息、情侣关系信息以及最重要的访问权限状态。这是应用启动后必须调用的第一个接口。
-   **认证**: `必须`
-   **成功响应 (200 OK)**:
    -   返回一个包含 `access_status`, `currentUser`, `partner`, `coupleInfo` 的对象。`access_status` 决定了前端的展示逻辑。
    -   **`access_status` 的可能值**:
        -   `ADMIN`: 管理员，拥有最高权限。
        -   `FULL_ACCESS`: 付费订阅生效中。
        -   `TRIAL`: 在免费试用期内。
        -   `EXPIRED`: 试用期或订阅已到期（需要显示支付弹窗）。
        -   `UNBOUND`: 单身，未绑定情侣。
-   **失败响应**: `401`

### **2. 情侣关系 (Couples)**

#### `POST /couples/invitations` - 创建绑定邀请

-   **描述**: 为当前用户生成一个唯一的、有时效性的邀请码，用于邀请另一半进行绑定。
-   **认证**: `必须`
-   **请求体**: (空)
-   **成功响应 (200 OK)**:
    ```json
    {
      "invite_code": "A8C3F9", // string: 6位随机邀请码
      "expires_at": "2023-10-28T14:55:00Z" // string (ISO 8601): 邀请码过期时间
    }
    ```
-   **失败响应**: `401`, `403` (如果用户已绑定)

#### `POST /couples/accept-invitation` - 接受绑定邀请

-   **描述**: 当前用户输入另一半分享的邀请码，完成情侣绑定。
-   **认证**: `必须`
-   **请求体**:
    ```json
    {
      "invite_code": "A8C3F9" // string: 要接受的邀请码
    }
    ```
-   **成功响应 (200 OK)**: 返回一个完整的会话对象，与 `GET /me` 格式相同，`access_status` 为 `TRIAL`。
-   **失败响应**: `400` (邀请码无效、过期或已被使用), `401`, `403` (如果用户已绑定)

#### `POST /couples/unbind` - 解绑情侣关系

-   **描述**: 用户确认解绑当前的情侣关系。后端将执行逻辑删除。
-   **认证**: `必须`
-   **请求体**: (空)
-   **成功响应 (200 OK)**: 返回一个全新的会话对象，与 `GET /me` 格式相同，`access_status` 为 `UNBOUND`。
-   **失败响应**: `401`, `403` (如果用户未绑定)

### **3. 订阅与支付 (Subscriptions)**

#### `GET /subscriptions/plans` - 获取可订阅的套餐

-   **描述**: 获取所有当前上架的可供购买的会员套餐列表。
-   **认证**: `必须`
-   **成功响应 (200 OK)**: 返回一个订阅套餐对象的数组。
-   **失败响应**: `401`

#### `POST /subscriptions` - 创建订阅订单

-   **描述**: 用户选择一个套餐并（可选地）输入一个优惠码来创建一个待支付订单。成功后，后端返回调起支付网关所需的信息。
-   **认证**: `必须`
-   **请求体**:
    ```json
    {
      "plan_id": "plan_yearly_249", // string: 要购买的套餐ID
      "promo_code": "SWEETLOVE25"     // string (optional): 使用的优惠码
    }
    ```
-   **成功响应 (200 OK)**: 返回订单信息和用于调起支付的 `payment_gateway_payload`。
-   **失败响应**: `400` (套餐ID或优惠码无效), `401`, `403` (用户未绑定或已经是会员)

---

## **第二部分：核心内容与交互 API**

### **4. 帖子/事件 (Events)**

#### `GET /events` - 获取帖子列表

-   **描述**: 根据状态获取帖子列表，用于首页和"甜蜜档案"页面的展示。
-   **认证**: `必须`
-   **Query 参数**:
    -   `status` (string, `必须`): 过滤帖子的状态。可选值为 `unresolved` 或 `resolved`。
-   **成功响应 (200 OK)**: 返回一个帖子（Event）对象的数组。
-   **失败响应**: `400` (缺少status参数), `401`, `403`

#### `POST /events` - 新建帖子

-   **描述**: 创建一个新的"记仇"或"甜蜜时刻"帖子。
-   **认证**: `必须`
-   **请求体**:
    ```json
    {
      "type": "brainstorming", // string: 'brainstorming' 或 'sweet_moment'
      "description": "又玩游戏到半夜一点才睡，说好了要早睡的呢！", // string
      "event_date": "2023-10-28", // string: YYYY-MM-DD
      "mood_tag_id": 1, // number
      "images": [], // array of strings (optional): 图片URL列表
      "location_text": "卧室" // string (optional)
    }
    ```
-   **成功响应 (201 Created)**: 返回完整的新建帖子对象。
-   **失败响应**: `400` (参数验证失败), `401`, `403`

#### `GET /events/{eventId}` - 获取单个帖子详情

-   **描述**: 获取指定ID的帖子的详细信息。
-   **认证**: `必须`
-   **路径参数**:
    -   `eventId` (string (UUID)): 要获取的帖子的ID。
-   **成功响应 (200 OK)**: 返回单个帖子（Event）对象。
-   **失败响应**: `401`, `403`, `404` (帖子不存在)

#### `PUT /events/{eventId}` - 更新帖子

-   **描述**: 更新一个已存在的帖子，主要用于"解决"一个帖子。
-   **认证**: `必须`
-   **路径参数**:
    -   `eventId` (string (UUID)): 要更新的帖子的ID。
-   **请求体**:
    ```json
    {
      "solution": "沟通了一下，他保证之后十一点半之前一定睡觉...", // string
      "status": "resolved" // string
    }
    ```
-   **成功响应 (200 OK)**: 返回被完整更新后的帖子对象。
-   **失败响应**: `400` (参数验证失败), `401`, `403` (非作者或帖子已解决), `404`

#### `DELETE /events/{eventId}` - 删除帖子

-   **描述**: 逻辑删除一个帖子。只有作者可以删除。
-   **认证**: `必须`
-   **路径参数**:
    -   `eventId` (string (UUID)): 要删除的帖子的ID。
-   **成功响应 (200 OK)**: 返回一个包含被删除ID的简单对象。
-   **失败响应**: `401`, `403` (非作者), `404`

### **5. 情绪标签 (Mood Tags)**

#### `GET /mood-tags` - 获取所有可用的情绪标签

-   **描述**: 获取所有预设的情绪标签，用于前端发帖时选择。
-   **认证**: `必须`
-   **成功响应 (200 OK)**: 返回情绪标签对象的数组。
-   **失败响应**: `401`

### **6. 甜蜜留言 (Sweet Messages)**

#### `GET /sweet-messages` - 获取甜蜜留言板列表

-   **描述**: 获取情侣的甜蜜留言板上的所有留言。
-   **认证**: `必须`
-   **成功响应 (200 OK)**: 返回甜蜜留言对象的数组。
-   **失败响应**: `401`, `403`

#### `POST /sweet-messages` - 新建甜蜜留言

-   **描述**: 在留言板上发布一条新的留言。
-   **认证**: `必须`
-   **请求体**:
    ```json
    {
      "message": "今天也是超爱你的一天！", // string
      "nickname": "你的小太阳" // string
    }
    ```
-   **成功响应 (201 Created)**: 返回完整的新建留言对象。
-   **失败响应**: `400`, `401`, `403`

---

## **第三部分：系统与辅助 API**

### **7. 个人资料 (Profile)**

#### `PUT /me` - 更新用户个人资料

-   **描述**: 更新当前登录用户自己的个人资料。
-   **认证**: `必须`
-   **请求体**:
    ```json
    {
      "nickname": "改个新昵称", // string (optional)
      "bio": "新的简介，新的开始！" // string (optional)
    }
    ```
-   **成功响应 (200 OK)**: 返回一个仅包含更新后 `currentUser` 信息的对象。
-   **失败响应**: `400`, `401`

### **8. 通知中心 (Notifications)**

#### `GET /notifications` - 获取通知中心列表

-   **描述**: 获取当前用户的通知列表，包括未读计数。
-   **认证**: `必须`
-   **成功响应 (200 OK)**: 返回一个包含 `unread_count` 和 `notifications` 数组的对象。
-   **失败响应**: `401`

### **9. 数据分析 (Analytics)**

#### `GET /analytics/mood` - 获取心情分析数据

-   **描述**: 获取用于渲染"心情"页面图表的数据。
-   **认证**: `必须`
-   **Query 参数**:
    -   `period` (string, `必须`): 分析周期。可选值为 `weekly` 或 `monthly`。
-   **成功响应 (200 OK)**: 返回一个包含 `trend` (趋势图数据) 和 `distribution` (分布饼图数据) 的对象。
-   **失败响应**: `400` (缺少period参数), `401`, `403`

---
