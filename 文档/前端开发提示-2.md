# **恋心物语 - 微信小程序开发指令 (精简版)**

**项目标识**: `lianxin-wuyu-miniprogram`

---

## **核心要求**

**你的任务**: 开发「恋心物语」微信小程序的全部前端代码。使用微信小程序应该使用原生的语法

**技术栈**:
1. **框架**: 原生微信小程序 (`WXML`, `WXSS`, `TypeScript`)
2. **UI库**: **iView Weapp** (已安装在 `/miniapp/iview/`)
3. **状态管理**: `mobx-miniprogram`
4. **样式**: SCSS 预处理器
5. **目录**: 所有代码在 `/miniapp/` 文件夹内

**数据契约**: 严格按照本文档第四部分的模拟数据进行开发。

---

## **项目结构**

```
/miniapp/
|-- components/             # 自定义组件
|-- iview/                  # 【已存在】UI组件库
|-- pages/                  # 所有页面
|   |-- index/              # 首页
|   |-- auth/               # 登录页
|   |-- couple/             # 情侣绑定页
|   |-- profile/            # 个人中心
|-- services/               # API服务
|   |-- api.js              # 请求封装
|-- store/                  # 状态管理
|   |-- user.js             # 用户状态
|   |-- event.js            # 事件状态
|-- styles/                 # 全局样式
|-- app.js                  # 入口文件
|-- app.json                # 全局配置
```

---

## **iView Weapp 使用规范**

### **全局引入** (在 `app.json` 中)
```json
"usingComponents": {
  "i-button": "/iview/button/index",
  "i-card": "/iview/card/index",
  "i-tag": "/iview/tag/index",
  "i-progress": "/iview/progress/index",
  "i-avatar": "/iview/avatar/index",
  "i-icon": "/iview/icon/index"
}
```

### **主题色覆盖** (在 `app.wxss` 中)
```css
page {
  background-color: #FFF9F5;
  --primary-color: #FADADD;
  --info-color: #B2D9EA;
}
```

### **组件使用映射**
| 需求 | 组件 | 关键属性 |
|------|------|----------|
| 主按钮 | `i-button` | `type="primary" size="large"` |
| 卡片 | `i-card` | `full="true"` |
| 标签 | `i-tag` | `color="primary"` 或 `color="info"` |
| 进度条 | `i-progress` | `stroke-color="#FADADD"` |
| 头像 | `i-avatar` | `src="{{url}}" shape="circle"` |

---

## **开发路线**

### **Phase 1: 认证流程**
1. **登录页** (`pages/auth/index`)
   - UI: 使用 `<i-button type="primary">微信授权登录</i-button>`
   - 逻辑: `wx.login()` → 调用登录API → 存储token → 跳转

2. **绑定页** (`pages/couple/index`)
   - UI: 使用 `i-panel`、`i-input`、`i-button`
   - 逻辑: 生成邀请码 → 输入对方邀请码 → 绑定成功

### **Phase 2: 核心功能**
1. **首页** (`pages/index/index`)
   - UI: `i-avatar` + `i-progress` + `i-card` 列表
   - 逻辑: 展示情侣信息、爱情指数、未解决事件

2. **其他页面**: 事件详情、新增事件、个人中心等

---

## **关键模拟数据**

### **1. 用户会话信息** (`GET /api/me`)

**付费用户场景**:
```json
{
  "code": 200,
  "data": {
    "access_status": "FULL_ACCESS",
    "currentUser": {
      "id": "b2c3d4e5-0003-4003-8003-112233445566",
      "nickname": "付费用户A",
      "avatar_url": "https://randomuser.me/api/portraits/women/68.jpg",
      "display_gender": "female"
    },
    "partner": {
      "id": "b2c3d4e5-0004-4004-8004-aabbccddeeff",
      "nickname": "付费用户B",
      "avatar_url": "https://randomuser.me/api/portraits/men/68.jpg",
      "display_gender": "male"
    },
    "coupleInfo": {
      "id": "c1p2l3e4-0002-4002-8002-654321fedcba",
      "anniversary_date": "2022-08-08",
      "subscription_expires_at": "2024-09-08T12:00:00Z"
    }
  }
}
```

**未绑定用户场景**:
```json
{
  "code": 200,
  "data": {
    "access_status": "UNBOUND",
    "currentUser": {
      "id": "e5f6g7h8-0009-4009-8009-1a2b3c4d5e6f",
      "nickname": "单身贵族C",
      "avatar_url": "https://randomuser.me/api/portraits/lego/1.jpg"
    },
    "partner": null,
    "coupleInfo": null
  }
}
```

### **2. 事件列表** (`GET /api/events?status=unresolved`)
```json
{
  "code": 200,
  "data": [
    {
      "id": "evt-uuid-001",
      "type": "brainstorming",
      "description": "说好的一起看电影，结果开场十分钟就睡着了！",
      "status": "unresolved",
      "event_date": "2023-10-26",
      "author": {
        "id": "b2c3d4e5-0003-4003-8003-112233445566",
        "nickname": "付费用户A",
        "display_gender": "female"
      },
      "mood_tag": {
        "id": 1,
        "name": "生气",
        "emoji_icon": "😠"
      },
      "created_at": "2023-10-26T22:30:00Z"
    }
  ]
}
```

### **3. 情绪标签** (`GET /api/mood-tags`)
```json
{
  "code": 200,
  "data": [
    { "id": 1, "name": "生气", "emoji_icon": "😠", "category": "negative" },
    { "id": 2, "name": "委屈", "emoji_icon": "🥺", "category": "negative" },
    { "id": 5, "name": "感动", "emoji_icon": "🥰", "category": "positive" },
    { "id": 6, "name": "开心", "emoji_icon": "😄", "category": "positive" }
  ]
}
```

### **4. 创建邀请码** (`POST /api/couples/invitations`)
```json
{
  "code": 200,
  "data": {
    "invite_code": "A8C3F9",
    "expires_at": "2023-10-28T14:55:00Z"
  }
}
```

---

## **状态管理实现**

### **用户Store** (`store/user.js`)
```javascript
import { observable, action } from 'mobx-miniprogram'

export const userStore = observable({
  currentUser: null,
  partner: null,
  coupleInfo: null,
  accessStatus: 'UNBOUND',

  fetchUserSession: action(function() {
    // 调用 GET /api/me
    // 更新上述状态
  }),

  get isCoupleBound() {
    return this.accessStatus !== 'UNBOUND'
  }
})
```

---

## **API服务封装** (`services/api.js`)
```javascript
const BASE_URL = '/api'

function request(url, options = {}) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: BASE_URL + url,
      method: options.method || 'GET',
      data: options.data,
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('access_token')}`,
        ...options.header
      },
      success: (res) => {
        if (res.data.code === 401) {
          wx.removeStorageSync('access_token')
          wx.reLaunch({ url: '/pages/auth/index' })
          return
        }
        resolve(res.data)
      },
      fail: reject
    })
  })
}

export default { request }
```

---

## **执行指令**

按照上述规范和数据，从Phase 1开始，创建标准小程序文件并编写代码。确保所有UI通过iView Weapp实现，所有数据结构与模拟数据完全匹配。
